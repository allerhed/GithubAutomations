name: Inbox Monitor ‚Üí Copilot Automation

on:
  push:
    paths: ["inbox/**"]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Monitor inbox folder for new/edited files and delegate to Copilot
  inbox_monitor:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Ensure required labels exist
      - name: Setup labels
        run: |
          gh label create "copilot-task" --description "Task assigned to Copilot agent" --color "0366d6" || true
          gh label create "inbox-item" --description "Generated from inbox file" --color "7057ff" || true
          gh label create "auto-generated" --description "Automatically generated" --color "fbca04" || true
          gh label create "enhancement" --description "New feature or request" --color "a2eeef" || true
          gh label create "bug" --description "Something isn't working" --color "d73a49" || true
          gh label create "documentation" --description "Improvements or additions to documentation" --color "0075ca" || true
          gh label create "backend" --description "Backend related" --color "5319e7" || true
          gh label create "payments" --description "Payment system related" --color "ff6b6b" || true
          gh label create "configuration" --description "Configuration changes" --color "f9ca24" || true

      # Check if Copilot is available in the repository
      - name: Check Copilot availability
        run: |
          echo "üîç Checking GitHub Copilot availability..."
          # Check if repository has Copilot enabled (this will help with debugging)
          echo "Repository: ${{ github.repository }}"
          echo "Workflow triggered by: ${{ github.event_name }}"
          echo "GitHub actor: ${{ github.actor }}"

      # Find changed files in inbox/
      - name: Detect inbox changes
        id: changes
        run: |
          git diff --name-only --diff-filter=AM "${{ github.event.before }}" "${{ github.sha }}" -- 'inbox/**' > changed_files.txt
          file_count=$(wc -l < changed_files.txt)
          echo "count=$file_count" >> "$GITHUB_OUTPUT"
          if [ "$file_count" -gt 0 ]; then
            echo "üìÅ Detected changes in inbox files:"
            cat changed_files.txt
          fi

      # Process each changed file
      - name: Delegate to Copilot Agent
        if: steps.changes.outputs.count != '0'
        run: |
          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue
            
            filename=$(basename "$filepath")
            echo "üîÑ Processing: $filepath"

            # Prepare file content for Copilot
            if [ "$(wc -c < "$filepath")" -gt 900000 ]; then
              head -c 900000 "$filepath" > /tmp/content.txt
              echo -e "\n\n[TRUNCATED: File was too large for processing]" >> /tmp/content.txt
            else
              cp "$filepath" /tmp/content.txt
            fi

            # Create comprehensive prompt for Copilot
            {
              echo "## ü§ñ GitHub Copilot Agent Task"
              echo ""
              echo "### Assignment: Analyze Inbox File and Create Issues/PRs"
              echo ""
              echo "**File to Process:** \`$filepath\`"
              echo "**Repository:** ${{ github.repository }}"
              echo "**Commit:** ${{ github.sha }}"
              echo ""
              echo "### Instructions for Copilot Agent:"
              echo ""
              echo "Please analyze the content below and automatically create appropriate GitHub Issues and Pull Requests:"
              echo ""
              echo "#### 1. Content Analysis"
              echo "- Examine the file content thoroughly"
              echo "- Identify: bug reports, feature requests, code snippets, documentation, configuration files"
              echo ""
              echo "#### 2. Create Issues For:"
              echo "- **Bug Reports:** Create detailed issues with reproduction steps, expected vs actual behavior"
              echo "- **Feature Requests:** Create enhancement issues with clear requirements and acceptance criteria"
              echo "- **Questions/Discussions:** Create discussion issues for clarification needs"
              echo ""
              echo "#### 3. Create Pull Requests For:"
              echo "- **Code/Config/Docs:** Create draft PRs implementing the suggested changes"
              echo "- **Include:** Appropriate tests, documentation updates, clear commit messages"
              echo "- **Branch naming:** Use pattern 'copilot/$(echo ${{ github.sha }} | cut -c1-8)-$(echo $filename | tr -cs \"[:alnum:]\" \"-\")'"
              echo ""
              echo "#### 4. Requirements:"
              echo "- Reference this coordination issue (#ISSUE_NUMBER) in all created items"
              echo "- Use appropriate labels: \`bug\`, \`enhancement\`, \`documentation\`, \`question\`"
              echo "- Follow repository best practices and existing patterns"
              echo "- Add detailed descriptions and context to all created items"
              echo ""
              echo "---"
              echo ""
              echo "### File Content to Analyze:"
              echo ""
              echo '```'
              cat /tmp/content.txt
              echo '```'
              echo ""
              echo "### Next Steps:"
              echo "1. Respond with üëÄ to acknowledge this task"
              echo "2. Analyze the content and create appropriate Issues/PRs"
              echo "3. Comment back here with links to created items"
              echo ""
              echo "**Ready for processing!** üöÄ"
            } > /tmp/task.md

            # Create coordination issue for Copilot Agent
            issue_url=$(gh issue create \
              --title "ü§ñ Copilot Agent: Process $filename" \
              --body-file /tmp/task.md \
              --label copilot-task,inbox-item,auto-generated)

            echo "‚úÖ Created Copilot coordination issue: $issue_url"

            # Extract issue number for follow-up actions
            issue_num=$(echo "$issue_url" | grep -o '[0-9]*$')
            
            if [ -n "$issue_num" ]; then
              # Add multiple trigger approaches to ensure Copilot sees the task
              echo "ü§ñ @copilot please analyze and process this inbox file as described above." | \
                gh issue comment "$issue_num" --body-file -
              
              # Also try alternative mentions that might trigger the agent
              echo "/copilot analyze" | gh issue comment "$issue_num" --body-file - || true
              echo "@github-copilot[bot] please process this file" | gh issue comment "$issue_num" --body-file - || true
              
              echo "üìå Added trigger comments to issue #$issue_num"
            fi

          done < changed_files.txt

      # Create individual issues for each item in intake files and assign copilot-swe-agent
      - name: Create Individual Issues and Assign Copilot SWE Agent
        if: steps.changes.outputs.count != '0'
        run: |
          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue
            
            filename=$(basename "$filepath")
            echo "üéØ Creating individual issues for: $filepath"

            # Parse the file for structured items (Features, Bugs, Docs)
            if grep -q "## 1) Feature:" "$filepath"; then
              echo "üìù Creating Feature issue..."
              feature_title=$(grep "## 1) Feature:" "$filepath" | sed 's/## 1) Feature: //')
              
              # Extract feature content
              awk '/## 1\) Feature:/,/^---$/{if(!/^---$/) print}' "$filepath" > /tmp/feature.md
              
              # Create feature issue
              feature_issue=$(gh issue create \
                --title "‚ú® $feature_title" \
                --body-file /tmp/feature.md \
                --label enhancement,backend,inbox-item \
                --assignee copilot-swe-agent || true)
              
              echo "‚úÖ Created feature issue: $feature_issue"
              
              # Add Copilot trigger comment
              feature_num=$(echo "$feature_issue" | grep -o '[0-9]*$')
              if [ -n "$feature_num" ]; then
                echo "ü§ñ @copilot please implement this feature request. Break it down into smaller tasks and create a plan." | \
                  gh issue comment "$feature_num" --body-file - || true
              fi
            fi

            if grep -q "## 2) Bug:" "$filepath"; then
              echo "üêõ Creating Bug issue..."
              bug_title=$(grep "## 2) Bug:" "$filepath" | sed 's/## 2) Bug: //')
              
              # Extract bug content
              awk '/## 2\) Bug:/,/^---$/{if(!/^---$/) print}' "$filepath" > /tmp/bug.md
              
              # Create bug issue
              bug_issue=$(gh issue create \
                --title "üêõ $bug_title" \
                --body-file /tmp/bug.md \
                --label bug,payments,inbox-item \
                --assignee copilot-swe-agent || true)
              
              echo "‚úÖ Created bug issue: $bug_issue"
              
              # Add Copilot trigger comment
              bug_num=$(echo "$bug_issue" | grep -o '[0-9]*$')
              if [ -n "$bug_num" ]; then
                echo "ü§ñ @copilot please investigate and fix this bug. Create a reproduction test first." | \
                  gh issue comment "$bug_num" --body-file - || true
              fi
            fi

            if grep -q "## 3) Docs:" "$filepath"; then
              echo "üìö Creating Documentation issue..."
              docs_title=$(grep "## 3) Docs:" "$filepath" | sed 's/## 3) Docs: //')
              
              # Extract docs content
              awk '/## 3\) Docs:/,/^---$/{if(!/^---$/) print}' "$filepath" > /tmp/docs.md
              
              # Create docs issue
              docs_issue=$(gh issue create \
                --title "üìö $docs_title" \
                --body-file /tmp/docs.md \
                --label documentation,inbox-item \
                --assignee copilot-swe-agent || true)
              
              echo "‚úÖ Created documentation issue: $docs_issue"
              
              # Add Copilot trigger comment
              docs_num=$(echo "$docs_issue" | grep -o '[0-9]*$')
              if [ -n "$docs_num" ]; then
                echo "ü§ñ @copilot please update the documentation as described." | \
                  gh issue comment "$docs_num" --body-file - || true
              fi
            fi

            if grep -q "## 4) Code/Config to integrate via PR" "$filepath"; then
              echo "‚öôÔ∏è Creating Configuration PR issue..."
              
              # Extract config content
              awk '/## 4\) Code\/Config to integrate via PR/,EOF' "$filepath" > /tmp/config.md
              
              # Create config PR coordination issue
              config_issue=$(gh issue create \
                --title "‚öôÔ∏è Create Configuration PR: rate-limits.json" \
                --body-file /tmp/config.md \
                --label enhancement,configuration,inbox-item \
                --assignee copilot-swe-agent || true)
              
              echo "‚úÖ Created configuration PR issue: $config_issue"
              
              # Add Copilot trigger comment
              config_num=$(echo "$config_issue" | grep -o '[0-9]*$')
              if [ -n "$config_num" ]; then
                echo "ü§ñ @copilot please create a draft PR implementing the configuration changes as described." | \
                  gh issue comment "$config_num" --body-file - || true
              fi
            fi

          done < changed_files.txt

  # Try to trigger Copilot on new issues
  auto_assign_issues:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Copilot on new issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìù New issue #${{ github.event.issue.number }} was created"
          echo "ü§ñ @copilot please review this new issue and provide assistance if needed." | \
            gh issue comment "${{ github.event.issue.number }}" --body-file - || true

  # Try to trigger Copilot on new PRs
  auto_assign_prs:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Copilot on new PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÄ New PR #${{ github.event.pull_request.number }} was created"
          echo "ü§ñ @copilot please review this new pull request." | \
            gh issue comment "${{ github.event.pull_request.number }}" --body-file - || true
