name: Inbox Monitor ‚Üí Copilot Automation

on:
  push:
    paths: ["inbox/**"]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Monitor inbox folder for new/edited files and delegate to Copilot
  inbox_monitor:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Ensure required labels exist
      - name: Setup labels
        run: |
          gh label create "copilot-task" --description "Task assigned to Copilot agent" --color "0366d6" || true
          gh label create "inbox-item" --description "Generated from inbox file" --color "7057ff" || true
          gh label create "auto-generated" --description "Automatically generated" --color "fbca04" || true

      # Find changed files in inbox/
      - name: Detect inbox changes
        id: changes
        run: |
          git diff --name-only --diff-filter=AM "${{ github.event.before }}" "${{ github.sha }}" -- 'inbox/**' > changed_files.txt
          file_count=$(wc -l < changed_files.txt)
          echo "count=$file_count" >> "$GITHUB_OUTPUT"
          if [ "$file_count" -gt 0 ]; then
            echo "üìÅ Detected changes in inbox files:"
            cat changed_files.txt
          fi

      # Process each changed file
      - name: Delegate to Copilot Agent
        if: steps.changes.outputs.count != '0'
        run: |
          while IFS= read -r filepath; do
            [ -z "$filepath" ] && continue
            
            filename=$(basename "$filepath")
            echo "üîÑ Processing: $filepath"

            # Prepare file content for Copilot
            if [ "$(wc -c < "$filepath")" -gt 900000 ]; then
              head -c 900000 "$filepath" > /tmp/content.txt
              echo -e "\n\n[TRUNCATED: File was too large for processing]" >> /tmp/content.txt
            else
              cp "$filepath" /tmp/content.txt
            fi

            # Create comprehensive prompt for Copilot
            {
              echo "@copilot-swe-agent"
              echo ""
              echo "## Assignment: Analyze Inbox File and Take Action"
              echo ""
              echo "You are tasked with analyzing the content below and automatically creating appropriate Issues and Pull Requests based on what you find."
              echo ""
              echo "### Your Instructions:"
              echo ""
              echo "**1. Content Analysis:**"
              echo "- Read and understand the file content completely"
              echo "- Identify if it contains: bug reports, feature requests, code snippets, documentation, or configuration"
              echo ""
              echo "**2. Issue Creation:**"
              echo "- For bugs/problems: Create detailed bug report issues with reproduction steps"
              echo "- For feature requests: Create enhancement issues with clear requirements and acceptance criteria"
              echo "- For questions/discussions: Create discussion issues"
              echo ""
              echo "**3. Pull Request Creation:**"
              echo "- For code/config/docs that should be integrated: Create draft PRs implementing the changes"
              echo "- Include tests and documentation where appropriate"
              echo "- Use descriptive commit messages and PR descriptions"
              echo ""
              echo "**4. Assignment Requirements:**"
              echo "- Assign yourself (@copilot-swe-agent) to EVERY issue and PR you create"
              echo "- Reference this coordination issue in all created items"
              echo "- Use appropriate labels: bug, enhancement, documentation, question, etc."
              echo "- Follow repository best practices"
              echo ""
              echo "**5. Branch Naming:**"
              echo "Use pattern: copilot/${{ github.sha }}-$(echo '$filename' | tr -cs '[:alnum:]' '-')"
              echo ""
              echo "---"
              echo ""
              echo "### Source File Details:"
              echo "- **File:** \`$filepath\`"
              echo "- **Repository:** ${{ github.repository }}"
              echo "- **Commit:** ${{ github.sha }}"
              echo "- **Triggered by:** Push to inbox folder"
              echo ""
              echo "### File Content:"
              echo '```'
              cat /tmp/content.txt
              echo '```'
              echo ""
              echo "**Next Steps:** Please analyze this content and create appropriate Issues/PRs as outlined above."
            } > /tmp/task.md

            # Create coordination issue for Copilot
            issue_url=$(gh issue create \
              --title "@copilot-swe-agent: Process inbox file - $filename" \
              --body-file /tmp/task.md \
              --label copilot-task,inbox-item,auto-generated \
              --assignee copilot-swe-agent)

            echo "‚úÖ Created Copilot coordination issue: $issue_url"

            # Add follow-up comment to ensure visibility
            issue_num=$(echo "$issue_url" | grep -o '[0-9]*$')
            if [ -n "$issue_num" ]; then
              echo "üìã @copilot-swe-agent Please begin processing this inbox file and create any necessary Issues/PRs as described above." | \
                gh issue comment "$issue_num" --body-file -
            fi

          done < changed_files.txt

  # Ensure Copilot is assigned to any new issues created
  auto_assign_issues:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign Copilot to new issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit "${{ github.event.issue.number }}" --add-assignee copilot-swe-agent || true

  # Ensure Copilot is assigned to any new PRs created  
  auto_assign_prs:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign Copilot to new PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit "${{ github.event.pull_request.number }}" --add-assignee copilot-swe-agent || true
