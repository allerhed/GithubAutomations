name: Inbox ‚Üí Copilot triage

on:
  push:
    paths: ["inbox/**"]
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  intake:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Find files newly ADDED under inbox/ in this push
      - name: List newly-added inbox files
        id: diff
        run: |
          git fetch --depth=1 origin "${{ github.event.before }}" || true
          git diff --name-only --diff-filter=A "${{ github.event.before }}" "${{ github.sha }}" -- 'inbox/**' > added.txt
          echo "count=$(wc -l < added.txt)" >> "$GITHUB_OUTPUT"
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          cat added.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      # Detect if copilot-swe-agent is assignable in this repo
      - name: Detect Copilot agent availability
        id: copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          RESP=$(gh api graphql -f query='
            query($o:String!,$r:String!){
              repository(owner:$o,name:$r){
                suggestedActors(capabilities:[CAN_BE_ASSIGNED], first:100){
                  nodes{ login __typename ... on Bot{id} ... on User{id} }
                }
              }
            }' -F o="$OWNER" -F r="$REPO")
          ID=$(echo "$RESP" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login=="copilot-swe-agent") | .id')
          if [ -n "$ID" ] && [ "$ID" != "null" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "id=$ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Copilot agent is assignable (id: $ID)"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Copilot agent not assignable in this repo."
          fi

      # Create a Copilot task Issue per new file, embedding the content + instructions
      - name: Create Copilot task issues (one per file)
        if: steps.diff.outputs.count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "üéØ Creating task issue for: $f"

            # Read file content (truncate if huge to avoid API limits)
            if [ "$(wc -c < "$f")" -gt 950000 ]; then
              head -c 950000 "$f" > /tmp/file_body.txt
              echo -e "\n\n[NOTE: truncated for length]" >> /tmp/file_body.txt
            else
              cp "$f" /tmp/file_body.txt
            fi

            # Build task prompt for Copilot
            {
              echo "## Task"
              echo "You are \`copilot-swe-agent\`. Analyze the file below and take actions:"
              echo "- If it describes bugs or features: create Issues with titles, summaries, acceptance criteria, and TODO checklists."
              echo "- If it is code/config/docs to integrate: open a **draft PR** implementing the change, with tests/docs as needed."
              echo "- Reference this task Issue in everything you create and link back."
              echo "- Apply labels based on content (\`bug\`, \`enhancement\`, \`documentation\`)."
              echo "- **Assign \`copilot-swe-agent\` to every Issue and PR you create.**"
              echo "- Branch naming suggestion: \`copilot/${GITHUB_SHA::7}-$(basename "$f" | tr -cs '[:alnum:]' -)\`."
              echo
              echo "## Source file"
              echo "Path: \`$f\`"
              echo
              echo '```'
              cat /tmp/file_body.txt
              echo
              echo '```'
              echo
              echo "## Notes"
              echo "- If information is missing, proceed with best effort and leave questions as PR review comments."
              echo "- Keep PRs small and incremental; follow CONTRIBUTING.md if present."
            } > /tmp/body.md

            # Create the Issue; assign Copilot if available
            ASSIGNEE_ARG=""
            if [ "${{ steps.copilot.outputs.available }}" = "true" ]; then
              ASSIGNEE_ARG="--assignee copilot-swe-agent"
            fi

            gh issue create \
              --title "Copilot: Analyze and act on $(basename "$f")" \
              --body-file /tmp/body.md \
              --label automation,copilot,from-file \
              $ASSIGNEE_ARG
          done < added.txt

  # Belt-and-suspenders: auto-assign Copilot to any newly opened Issue
  auto_assign_issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Assign copilot-swe-agent to Issue (if available)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to assign; if agent isn't available, this will no-op
          gh issue edit "${{ github.event.issue.number }}" --add-assignee copilot-swe-agent || true

  # Belt-and-suspenders: auto-assign Copilot to any newly opened PR
  auto_assign_pr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Assign copilot-swe-agent to PR (if available)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PRs are issues under the hood
          gh issue edit "${{ github.event.pull_request.number }}" --add-assignee copilot-swe-agent || true
